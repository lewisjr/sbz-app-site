use napi_derive::napi;

pub mod types;
pub mod utils;

use types::{Setting, SettledInfo, SettledTrade};
use utils::to_int;

/// Find the next fibonacci sequence number
#[napi]
pub fn fibonacci(n: u32) -> u32 {
    match n {
        1 | 2 => 1,
        _ => fibonacci(n - 1) + fibonacci(n - 2),
    }
}

/// handle the settlement report; based on *7 Oct 2025* settlement report
#[napi]
pub fn settle_v1(raw_str: String) -> SettledInfo {
    let raw_str_clean = raw_str.replace("-FC", "-LI");

    let mut split_one: Vec<&str> = raw_str_clean.split("REFERENCEBROKER").collect();
    let date_1 = split_one.remove(0);

    // println!("\n=== date_1 = {}\n", date_1);

    let date_2_vec: Vec<&str> = date_1.split("produced on ").collect();
    let date_3_vec: Vec<&str> = date_2_vec[1].split("/").collect();

    let date = to_int(&format!(
        "{}{}{}",
        &date_3_vec[2][..4],
        date_3_vec[1],
        date_3_vec[0]
    ));

    // println!("\n=== date = {}\n", date);

    // println!("\n=== split_one\n{:#?}\n===\n\n", split_one);

    let mut setting: Setting = Setting::BUYS;

    let mut trades: Vec<SettledTrade> = vec![];

    let mut total_buys: f64 = 0.0;
    let mut total_buy_clients: i64 = 0;
    let mut total_sells: f64 = 0.0;
    let mut total_sell_clients: i64 = 0;

    for (_, data) in split_one.iter().enumerate() {
        let mut split_two: Vec<&str> = data.split(" FIRM").collect();
        split_two.remove(0);

        /*
        if i == 0 {
            println!("\n=== split_two\n{:#?}\n===\n\n", split_two);
        }
        */

        for table in split_two {
            let rows: Vec<&str> = table.split("/B").collect();

            //if i == 0 {
            println!("\n=== rows\n{:#?}\n===\n\n", rows);

            for row in rows {
                if row.len() > 5 {
                    if row.contains("Total ") {
                        if row.contains("Purchases") {
                            setting = Setting::SELLS
                        }
                    } else {
                        // println!("\n{:#?}\n", row);
                        let shareholder = SettledTrade::new(row, date, setting);
                        // println!("\n{:#?}\n", &shareholder);

                        match setting == Setting::BUYS {
                            true => {
                                total_buys = total_buys + shareholder.value;
                                total_buy_clients = total_buy_clients + 1;
                            }
                            _ => {
                                total_sells = total_sells + shareholder.value;
                                total_sell_clients = total_sell_clients + 1;
                            }
                        }

                        trades.push(shareholder);
                    }
                }
                //}
            }
        }
    }

    SettledInfo {
        data: trades,
        total_buy: total_buys,
        total_buy_clients: total_buy_clients,
        total_sell_clients: total_sell_clients,
        total_sell: total_sells,
        net_val: total_sells - total_buys,
        date,
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_zmw() {
        let _ = settle_v1(
            "1LUSE CSDFinal Trade Settlement Report - Equities BPIDSBZL/BSettlement Date07/10/2025CurrencyALL Report # 56698 produced on 07/10/2025 at 14:25 pm by BWA Participant SBZL/B STOCK BROKERS ZAMBIA LIMITEDCDS REFERENCEBROKER REFCLIENT IDSECURITY IDQUANTITYVALUECOUNTER FIRM822313101A88037B0000000476114-LICECZ81.001 942.38PERE/B822313301A88037D0000000476114-LICECZ1.0023.99SBZL/B822313701A88039B0000000478412-LICECZ20.00479.80SBZL/B822314301A88042B0000000489786-LIZNCO145.00894.65PERE/BTotal Purchases3 340.82CDS REFERENCEBROKER REFCLIENT IDSECURITY IDQUANTITYVALUECOUNTER FIRM822315201A88046A0000000473908-LIBATA3.0019.50LHAB/B822315401A88046C0000000473908-LIBATA80.00496.00ECRP/B822315601A88046E0000000473908-LIBATA49.00303.80ECRP/B822315801A88046G0000000473908-LIBATA3.0018.60HOBB/B822316001A88046I0000000473908-LIBATA50.00310.00LHAB/B822316201A88046K0000000473908-LIBATA20.00124.00HOBB/B822320401A88055A0000000473908-LIBATA100.00620.00LHAB/B822331001A88093A0000000473908-LIBATA2.0012.40LHAB/B822331801A88096A0000000473908-LIBATA100.00620.00LHAB/B822333201A88103A0000000473908-LIBATA20.00124.00HOBB/B822334401A88109A0000000473908-LIBATA21.00130.20LHAB/B822302801A87991A0000000430927-FCBATZ25.00400.00ECRP/B822314801A88044A0000000430927-FCBATZ10.00160.00LHAB/B822321401A88060A0000000430927-FCBATZ100.001 600.00LHAB/B822325401A88075A0000000430927-FCBATZ5.0080.00HOBB/B822309201A88018A0000000318167-LICCAF200.00174.00LHAB/B822323001A88067A0000000173363-LICCAF922.00765.26LHAB/B822323201A88067C0000000173363-LICCAF70.0058.10LHAB/B822323401A88067E0000000173363-LICCAF25.0020.75LHAB/B822323601A88067G0000000173363-LICCAF37.0030.71LHAB/B822323801A88067I0000000173363-LICCAF206.00170.98ECRP/B822313401A88037C0000000370037-LICECZ1.0023.99SBZL/B822313801A88039A0000000370037-LICECZ20.00479.80SBZL/B822314001A88040A0000000370037-LICECZ4.0095.96LHAB/B822314601A88043A0000000370037-LICECZ4.0095.96HOBB/B822316401A88047A0000000370037-LICECZ1 700.0040 783.00LHAB/B822319001A88049A0000000370037-LICECZ20.00479.80LHAB/B822319201A88050A0000000370037-LICECZ10.00239.90HOBB/B822320801A88057A0000000370037-LICECZ5.00119.95LHAB/B822321601A88061A0000000370037-LICECZ100.002 399.00LHAB/B822324401A88070A0000000370037-LICECZ2.0047.98HOBB/B822324801A88072A0000000459733-LICECZ10.00239.80LHAB/B822325801A88077A0000000459733-LICECZ1.0023.98HOBB/B822330801A88092A0000000459733-LICECZ10.00239.80ECRP/B822331401A88095A0000000459733-LICECZ479.0011 486.42LHAB/B822331601A88095C0000000370037-LICECZ21.00503.79LHAB/B822332201A88098A0000000370037-LICECZ5.00119.95HOBB/B822333801A88106A0000000370037-LICECZ10.00239.90HOBB/B822334001A88107A0000000370037-LICECZ5.00119.95HOBB/B822335001A88112A0000000370037-LICECZ11.00263.89LHAB/B822335201A88113A0000000370037-LICECZ9.00215.91HOBB/B822326001A88078A0000000487575-LICHIL2.0075.80HOBB/B822326201A88078C0000000487575-LICHIL100.003 790.00HOBB/B822326401A88078E0000000487575-LICHIL30.001 137.00HOBB/B822326601A88078G0000000487575-LICHIL57.002 160.30ECRP/B822326801A88078I0000000487575-LICHIL6.00227.40ECRP/B822327001A88078K0000000487575-LICHIL1.0037.90LHAB/B822327201A88078M0000000487575-LICHIL25.00947.50LHAB/B822327401A88078O0000000487575-LICHIL2.0075.80HOBB/B822327601A88078Q0000000487575-LICHIL2.0075.80ECRP/B822327801A88078S0000000487575-LICHIL24.00909.60HOBB/B822328001A88078U0000000487575-LICHIL8.00303.20LHAB/B822328401A88080A0000000487575-LICHIL2.0075.80HOBB/B822328801A88082A0000000487575-LICHIL1.0037.90LHAB/B822329601A88086A0000000487575-LICHIL1.0037.90HOBB/B822332001A88097A0000000487575-LICHIL2.0075.80LHAB/B822333401A88104A0000000487575-LICHIL29.001 099.10LHAB/B822333601A88105A0000000487575-LICHIL100.003 790.00LHAB/B822335401A88114A0000000487575-LICHIL30.001 137.00LHAB/B822335801A88116A0000000487575-LICHIL1.0037.90HOBB/B822336001A88117A0000000487575-LICHIL2.0075.80LHAB/B822301201A87983A0000000430927-FCPUMA5.0021.80HOBB/B822304001A87996A0000000430927-FCPUMA20.0087.20HOBB/B2CDS REFERENCEBROKER REFCLIENT IDSECURITY IDQUANTITYVALUECOUNTER FIRM822309401A88019A0000000430927-FCPUMA23.00100.28LHAB/B822325001A88073A0000000430927-FCPUMA15.0065.40HOBB/B822332401A88099A0000000430927-FCPUMA26.00113.36HOBB/B822308801A88016A0000000033600-LIZABR15.00103.50ECRP/B822301401A87984A0000000430927-FCZFCO35.00120.75HOBB/B822303601A87994A0000000430927-FCZFCO50.00172.50HOBB/B822305401A88003A0000000430927-FCZFCO45.00155.25HOBB/B822305601A88004A0000000430927-FCZFCO3.0010.35HOBB/B822305801A88005A0000000430927-FCZFCO700.002 415.00LHAB/B822306001A88006A0000000430927-FCZFCO20.0069.00LHAB/B822307401A88009A0000000430927-FCZFCO8.0027.60HOBB/B822307601A88010A0000000430927-FCZFCO4.0013.80HOBB/B822309801A88021A0000000430927-FCZFCO20.0069.00ECRP/B822319801A88053A0000000430927-FCZFCO30.00103.50HOBB/B822322201A88063A0000000430927-FCZFCO200.00690.00LHAB/B822334201A88108A0000000430927-FCZFCO400.001 380.00LHAB/B822316601A88048A0000000473908-LIZMBF100.00240.00HOBB/B822316801A88048C0000000473908-LIZMBF50.00120.00HOBB/B822317001A88048E0000000473908-LIZMBF30.0060.00LHAB/B822317201A88048G0000000473908-LIZMBF10.0020.00HOBB/B822317401A88048I0000000473908-LIZMBF192.00382.08LHAB/B822317601A88048K0000000473908-LIZMBF45.0089.55LHAB/B822317801A88048M0000000473908-LIZMBF58.00115.42HOBB/B822318001A88048O0000000473908-LIZMBF29.0057.71HOBB/B822318201A88048Q0000000473908-LIZMBF100.00199.00HOBB/B822318401A88048S0000000473908-LIZMBF6.0011.94LHAB/B822318601A88048U0000000473908-LIZMBF99.00197.01HOBB/B822318801A88048W0000000473908-LIZMBF55.00109.45HOBB/B822304601A87999A0000000430927-FCZMFA3.00171.00HOBB/B822308001A88012A0000000430927-FCZMFA3.00171.00HOBB/B822308401A88014A0000000430927-FCZMFA12.00684.00HOBB/B822322401A88064A0000000430927-FCZMFA10.00570.00HOBB/B822332601A88100A0000000430927-FCZMFA20.001 140.00HOBB/B822334801A88111A0000000430927-FCZMFA1.0057.00LHAB/B822336201A88118A0000000430927-FCZMFA1.0057.00HOBB/BTotal Sales90 734.98Net Obligation      87 394.16 Report # 56698 Correctly terminated at 14:25 pm".to_string()
        );
    }
}
